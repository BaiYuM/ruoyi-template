<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.ExposureEventMapper">

  <insert id="insertExposureEvent" parameterType="com.ruoyi.system.domain.ExposureEvent" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO exposure_event (config_id, account, platform, exposure_time, exposure_count, create_time)
    VALUES (#{configId}, #{account}, #{platform}, #{exposureTime}, #{exposureCount}, #{createTime})
  </insert>

  <!-- 原子 upsert，依赖唯一索引 (config_id, account, platform) -->
  <insert id="upsertExposureEvent" parameterType="com.ruoyi.system.domain.ExposureEvent">
    INSERT INTO exposure_event (config_id, account, platform, exposure_time, create_time, exposure_count)
    VALUES (#{configId}, #{account}, #{platform}, #{exposureTime}, #{createTime}, #{exposureCount})
    ON DUPLICATE KEY UPDATE exposure_count = exposure_count + VALUES(exposure_count), exposure_time = VALUES(exposure_time)
  </insert>

  <update id="updateExposureEvent" parameterType="com.ruoyi.system.domain.ExposureEvent">
    UPDATE exposure_event
    SET exposure_count = #{exposureCount}, exposure_time = #{exposureTime}, create_time = #{createTime}
    WHERE config_id = #{configId} AND account = #{account} AND platform = #{platform}
  </update>

  <!-- 原子增量更新：对 exposure_count 加上 delta，并更新 exposure_time -->
  <update id="incrementExposureCount" parameterType="map">
    UPDATE exposure_event
    SET exposure_count = exposure_count + #{delta}, exposure_time = #{exposureTime}
    WHERE config_id = #{configId} AND account = #{account} AND platform = #{platform}
  </update>

  <!-- 只更新一行：优先匹配 config_id 的行；若不存在则匹配 (config_id IS NULL OR config_id = 0) 且 account/platform 相同的最小 id 行 -->
  <update id="incrementSingleRowByConfigOrAccountPlatform" parameterType="map">
    UPDATE exposure_event e
    JOIN (
      SELECT MIN(id) AS id FROM exposure_event
      WHERE (config_id = #{configId})
         OR ((config_id IS NULL OR config_id = 0) AND account = #{account} AND platform = #{platform})
      LIMIT 1
    ) t ON e.id = t.id
    SET e.exposure_count = e.exposure_count + #{delta}, e.exposure_time = #{exposureTime}
  </update>

  <select id="selectByConfigAccountPlatform" resultType="com.ruoyi.system.domain.ExposureEvent" parameterType="map">
    SELECT id, config_id, account, platform, exposure_time, exposure_count, create_time
    FROM exposure_event
    WHERE config_id = #{configId} AND account = #{account} AND platform = #{platform}
    LIMIT 1
  </select>

  <select id="selectLastExposureTime" resultType="java.util.Date">
    SELECT MAX(exposure_time) FROM exposure_event
    WHERE account = #{account} AND platform = #{platform}
  </select>

  <!-- 查询指定配置当天的曝光总数 -->
  <select id="selectTodayExposureCountByConfig" resultType="int" parameterType="long">
    SELECT COALESCE(SUM(exposure_count), 0)
    FROM exposure_event
    WHERE config_id = #{configId} AND DATE(exposure_time) = CURDATE()
  </select>

</mapper>
